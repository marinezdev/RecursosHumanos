
@{
    ViewBag.Title = "DocumentosCliente";
    Layout = "~/Views/Shared/_Layout _Administracion.cshtml";
}

<link rel="stylesheet" type="text/css" href="~/assets/icon/icofont/css/icofont.css">
<link rel="stylesheet" href="https://cdn.datatables.net/1.10.22/css/jquery.dataTables.min.css" />

<style>

    select.form-control, select.form-control:focus, select.form-control:hover {
        border-top: 1px;
        border-right: 1px;
        border-left: 1px;
        border: 1px solid #cccccc;
        border-radius: 2px;
    }

        select.form-control:not([size]):not([multiple]) {
            height: 36px;
        }

    .alert-warning {
        background-color: #fff;
        border-color: #e91e63;
        color: #fff;
        background: linear-gradient(to right, #e36c95, #e91e63);
        -webkit-box-shadow: 10px 10px 19px -11px rgba(51,51,51,1);
        -moz-box-shadow: 10px 10px 19px -11px rgba(51,51,51,1);
        box-shadow: 10px 10px 19px -11px rgba(51,51,51,1);
    }

    .sweet-mostrar {
        background: linear-gradient(to right, #b02750, #e91e63);
        color: #ffffff;
    }

        .sweet-mostrar:not([disabled]):hover {
            background-color: #e91e63;
            /*#hover here*/
        }

    .sweet-continuar {
        background: linear-gradient(to right, #00bcd4, #036fc5);
        color: #ffffff;
    }

        .sweet-continuar:not([disabled]):hover {
            background-color: #c755db;
            /*#hover here*/
        }

    .modal {
        z-index: 9999;
    }

    .process-step .btn:focus {
        outline: none
    }

    .process {
        display: table;
        width: 100%;
        position: relative
    }

    .process-row {
        display: table-row
    }

    .process-step button[disabled] {
        opacity: 1 !important;
        filter: alpha(opacity=100) !important
    }

    .process-row:before {
        top: 40px;
        bottom: 0;
        position: absolute;
        content: " ";
        width: 100%;
        height: 10px;
        background-color: #ccc;
        z-order: 0;
        border-radius: 5px;
    }

    .process-step {
        display: table-cell;
        text-align: center;
        position: relative
    }

        .process-step p {
            margin-top: 4px
        }

    .btn-uppload {
        background-color: #448aff;
        border-color: #008cb9;
        color: #0083b4;
        cursor: pointer;
        -webkit-transition: all ease-in 0.3s;
        transition: all ease-in 0.3s;
        background: linear-gradient(to right, #ffffff, #ffffff);
        width: 60px;
        border-radius: 5px;
    }

        .btn-uppload:hover {
            background-color: #448aff;
            border-color: #b7b7b7;
            color: #ffffff;
            cursor: pointer;
            -webkit-transition: all ease-in 0.3s;
            transition: all ease-in 0.3s;
            background: linear-gradient(to right, #b9b9b9, #cdcbcb);
        }

    .btn-uppload2 {
        background-color: #448aff;
        border-color: #008cb9;
        color: #0083b4;
        cursor: pointer;
        -webkit-transition: all ease-in 0.3s;
        transition: all ease-in 0.3s;
        background: linear-gradient(to right, #ffffff, #ffffff);
        border-radius: 5px;
    }

        .btn-uppload2:hover {
            background-color: #448aff;
            border-color: #b7b7b7;
            color: #ffffff;
            cursor: pointer;
            -webkit-transition: all ease-in 0.3s;
            transition: all ease-in 0.3s;
            background: linear-gradient(to right, #b9b9b9, #cdcbcb);
        }


    .btn-save {
        border-color: #519f55;
        color: #4caf50;
        cursor: pointer;
        transition: all ease-in 0.3s;
        background: linear-gradient(to right, #efffdc, #dfffba);
    }

        .btn-save:hover {
            border-color: #8bc34a;
            color: #ffffff;
            cursor: pointer;
            transition: all ease-in 0.3s;
            background: linear-gradient(to right, #8bc34a, #8bc34a);
        }

    .btn-danger {
        background: linear-gradient(to right, #9f1c1c, #e91e63);
        /* background-color: #ff5252; */
        border-color: #e91e63;
        color: #fff;
        cursor: pointer;
        -webkit-transition: all ease-in 0.3s;
        transition: all ease-in 0.3s;
        width: 60px;
        border-radius: 5px;
    }

        .btn-danger:hover {
            border-color: #c1c1c1;
            color: #cfbaba;
            cursor: pointer;
            -webkit-transition: all ease-in 0.3s;
            transition: all ease-in 0.3s;
            background: linear-gradient(to right, #a11041, #a50038);
        }

    .btn-view {
        background: linear-gradient(to right, #fff7d5, #fff1c6);
        /* background-color: #ff5252; */
        border-color: #ffc107;
        color: #ff9800;
        cursor: pointer;
        -webkit-transition: all ease-in 0.3s;
        transition: all ease-in 0.3s;
        width: 60px;
        border-radius: 5px;
    }

        .btn-view:hover {
            border-color: #ffeb3b;
            color: #ffffff;
            cursor: pointer;
            -webkit-transition: all ease-in 0.3s;
            transition: all ease-in 0.3s;
            background: linear-gradient(to right, #ff9800, #ff9800);
        }

    .btn-success {
        border-color: #ffffff;
        color: #fff;
        cursor: pointer;
        -webkit-transition: all ease-in 0.3s;
        transition: all ease-in 0.3s;
        background: linear-gradient(to right, #11c15b, #4caf50);
        width: 60px;
        border-radius: 5px;
    }

    .table-responsive {
        display: block;
        width: 100%;
        overflow-x: auto;
        -ms-overflow-style: -ms-autohiding-scrollbar;
    }
</style>


<div class="main-body">
    <div class="page-wrapper">
        <!-- Page-body start -->
        <div class="page-body">
            <div class="row">
                <div class="col-xl-12 col-md-12">
                    <!-- Basic Form Inputs card start -->
                    <div class="card">
                        <div class="card-header">
                            <h5>Consulta documentos por cliente  </h5>
                            <span>Empleados activos</span>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4 col-lg-4">
                                    <div class="form-group">
                                        <label for="largeInput">* Empresa   </label>
                                        <select class="form-control" id="Select_Empresa_Empleado" onchange="CargaClientes(this.value)">
                                            <option value="0">SELECCIONAR </option>
                                            @foreach (var item1 in ViewBag.Empresas)
                                            {
                                                <option value="@item1.Id">@item1.RazonSocial.ToUpper()</option>
                                            }
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-4 col-lg-4">
                                    <div class="form-group">
                                        <label for="largeInput">* Cliente   </label>
                                        <select class="form-control" id="Select_Cliente_Empleado"  onchange="CargaProyectosServicios(this.value)">
                                            <option value="0">SELECCIONAR </option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-4 col-lg-4">
                                    <div class="form-group">
                                        <label for="largeInput">* Proyecto o servicio </label>
                                        <select class="form-control" id="Select_Proyecto_Empleado">
                                            <option value="0">SELECCIONAR </option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4 col-lg-4">
                                    <button class="btn waves-effect waves-light btn-primary col-md-12 " id="BtnGeneraExcel" onclick="BtnGeneraConsulta()">  Consultar <i class="fa fa-search-plus"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            <div class="row" id="DivGraf1" style="display:none">
                <div class="col-xl-4 col-md-4">
                    <!-- Basic Form Inputs card start -->
                    <div class="card">
                        <div class="card-header">
                            <h5>Porcentaje de avance </h5>
                            <span>Empleados activos</span>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-12 col-lg-12" id="GraficaPocentaje">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-8 col-md-8">
                    @*Basic Form Inputs card start*@
                    <div class="card">
                        <div class="card-header">
                            <h5>Lista Empleados Documentos </h5>
                            <span>Empleados activos</span>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-12 table-responsive" id="TablaDocumentos">
                                    <table class='table text-center table-hover table-striped'>
                                        <thead class='thead-dark text-center'>
                                            <tr>
                                                <th class='text-center'><p style='margin-bottom: 0.5rem; margin-top:0.5rem;'></p></th>
                                                <th class='text-center'><p style='margin-bottom: 0.5rem; margin-top:0.5rem;'> </p></th>
                                                <th class='text-center'> </th>
                                                <th class='text-center'> </th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td></td>
                                                <td></td>
                                                <td></td>
                                                <td></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row" id="DivGraf2" style="display:none">
                <div class="col-xl-12 col-md-12">
                    <!-- Basic Form Inputs card start -->
                    <div class="card">
                        <div class="card-header">
                            <h5>Porcentaje de documentos (Avance - Faltante) </h5>
                            <span>Empleados activos</span>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-sm-12" id="GraficaListaDocumentos">
                                    <canvas id="densityChartPorcentajesDocumentosLista" width="600" height="250"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>



<script src="~/assets/js/jquery/jquery.min.js"></script>
<script src="~/assets/js/bootstrap-notify/bootstrap-notify.min.js"></script>
<script src="~/Vendor/chart.js/chart.min.js"></script>
<script src="https://cdn.datatables.net/1.10.22/js/jquery.dataTables.min.js"></script>

<script>
    $('#IdMenuReportes').addClass("active pcoded-trigger");
    $('#IdSubMenulistaDocumentosCliente').addClass("active");
</script>
<script>
    function CargaClientes(valor) {
        if (valor > 0) {

            var Empresas = new Object();
            Empresas.Id = valor;

            $.ajax({
                type: "POST",
                url: "@Url.Action("Cat_Clientes_Listar_IdEmpresa", "Clientes")",
                data: JSON.stringify(Empresas),
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (result) {
                    $("#Select_Cliente_Empleado").empty();

                    var option = $(document.createElement('option'));
                    option.text("SELECCIONAR");
                    option.val(0);

                    $("#Select_Cliente_Empleado").append(option);

                    if (result.length > 0) {
                        $(result).each(function () {
                            var option = $(document.createElement('option'));

                            option.text(this.Nombre.toUpperCase());
                            option.val(this.Id);

                            $("#Select_Cliente_Empleado").append(option);
                        });
                    }
                },
                error: errores
            });

        }
    }

    function CargaProyectosServicios(valor)
    {
        if ($('#Select_Cliente_Empleado option:selected').val() > 0) {
            $('#Select_Cliente_Empleado').css("border", "1px solid #cccccc");
        } else {
            $('#Select_Cliente_Empleado').css("border", "1px solid #f44336");
        }

        if (valor > 0) {

            var obj = {};
            obj['IdCliente'] = valor;

            var jsonObject = {
                "Cat_ProyectoServicios": obj
            };

            $.ajax({
                type: "POST",
                url: "@Url.Action("ProyectoServicios_Listar", "ProyectoServicios")",
                data: JSON.stringify(jsonObject),
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (result) {
                    $("#Select_Proyecto_Empleado").empty();

                    var option = $(document.createElement('option'));
                    option.text("SELECCIONAR");
                    option.val(0);

                    $("#Select_Proyecto_Empleado").append(option);


                    if (result.length > 0) {


                        $(result).each(function () {
                            var option = $(document.createElement('option'));

                            option.text(this.Nombre.toUpperCase());
                            option.val(this.Id);

                            $("#Select_Proyecto_Empleado").append(option);
                        });

                    }
                },
                error: errores
            });

        }
    }

    function BtnGeneraConsulta() {
        if (ValidaForm()) {
            $('#GraficaListaDocumentos').html("");

            $("#DivGraf1").show();
            $("#DivGraf2").show();

            var _Cliente = $("#Select_Cliente_Empleado option:selected").val();
            var _Proyecto = $("#Select_Proyecto_Empleado option:selected").val();

            if (_Proyecto == 0) {
                var Cat_Clientes = new Object();
                Cat_Clientes.Id = _Cliente;

                $.ajax({
                    type: "POST",
                    url: "@Url.Action("PersonasDocumento_Procentaje_Cliente", "Documentos")",
                    async: false,
                    data: JSON.stringify(Cat_Clientes),
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function (respuesta) {
                        $('#GraficaPocentaje').html('');
                        var contenido = "<div class='col text-center' style='padding: 30px 20px 30px 20px'>" +
                            "<h4 style='font-size: 25px; color: #3f51b5; '>¡Porcentaje de avance! </h4>" +
                            "<div id='GraficaPocentaje' style='height: 180px'>" +
                            "<canvas id='densityChartAvance' width='100%' height='200'></canvas>" +
                            "</div>" +
                            "<br />" +
                            "<p style='font-size:25px; color: #3f51b5; line-height: 0.0; ' id='PPorcentaje' >0 %</p>" +
                            "</div>";
                        $('#GraficaPocentaje').html(contenido);
                        PintagGraficaPorcentaje(respuesta);
                    },
                    error: errores
                });


                $.ajax({
                    type: "POST",
                    url: "@Url.Action("Reporte_Empleados_Documentos_Procentaje_Cliente", "Documentos")",
                    async: false,
                    data: JSON.stringify(Cat_Clientes),
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function (respuesta) {
                        $('#TablaDocumentos').html('');
                        PintagTablaPorcentaje(respuesta);
                    },
                    error: errores
                });

                $.ajax({
                    type: "POST",
                    url: "@Url.Action("PersonasDocumento_Documento_Procentaje_Cliente", "Documentos")",
                    async: false,
                    data: JSON.stringify(Cat_Clientes),
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function (respuesta) {
                        $('#GraficaListaDocumentos').html("<canvas id='densityChartPorcentajesDocumentosLista' width='600' height='250'></canvas>");
                        PintagTablaPorcentajeDocumentos(respuesta);
                    },
                    error: errores
                });
            }
            else {
                var Cat_ProyectoServicios = new Object();
                Cat_ProyectoServicios.Id = _Proyecto;
                Cat_ProyectoServicios.IdCliente = _Cliente;

                $.ajax({
                    type: "POST",
                    url: "@Url.Action("PersonasDocumento_Procentaje_Cliente_ProyectoServicio", "Documentos")",
                    async: false,
                    data: JSON.stringify(Cat_ProyectoServicios),
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function (respuesta) {
                        $('#GraficaPocentaje').html('');
                        var contenido = "<div class='col text-center' style='padding: 30px 20px 30px 20px'>" +
                            "<h4 style='font-size: 25px; color: #3f51b5; '>¡Porcentaje de avance! </h4>" +
                            "<div id='GraficaPocentaje' style='height: 180px'>" +
                            "<canvas id='densityChartAvance' width='100%' height='200'></canvas>" +
                            "</div>" +
                            "<br />" +
                            "<p style='font-size:25px; color: #3f51b5; line-height: 0.0; ' id='PPorcentaje' >0 %</p>" +
                            "</div>";
                        $('#GraficaPocentaje').html(contenido);
                        PintagGraficaPorcentaje(respuesta);
                    },
                    error: errores
                });

                $.ajax({
                    type: "POST",
                    url: "@Url.Action("Reporte_Empleados_Documentos_Procentaje_Cliente_ProyectoServicio", "Documentos")",
                    async: false,
                    data: JSON.stringify(Cat_ProyectoServicios),
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function (respuesta) {
                        $('#TablaDocumentos').html('');
                        PintagTablaPorcentaje(respuesta);
                    },
                    error: errores
                });

                $.ajax({
                    type: "POST",
                    url: "@Url.Action("PersonasDocumento_Documento_Procentaje_Cliente_ProyectoServicio", "Documentos")",
                    async: false,
                    data: JSON.stringify(Cat_ProyectoServicios),
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function (respuesta) {
                        $('#GraficaListaDocumentos').html("<canvas id='densityChartPorcentajesDocumentosLista' width='600' height='250'></canvas>");
                        PintagTablaPorcentajeDocumentos(respuesta);
                    },
                    error: errores
                });
            }

            var posicion = $("#DivGraf1").offset().top;
            $("html, body").animate({
                scrollTop: posicion - 100
            }, 1000);

        } else {
            $.notify({
                icon: 'fa fa-paw',
                message: "Debes completar el formulario.",
            }, {
                type: 'warning',
                allow_dismiss: false,
                animate: {
                    enter: 'animated rollIn',
                    exit: 'animated rollOut'
                }
            });
        }
    }

    function PintagTablaPorcentaje(respuesta) {

        var your_object = JSON.parse(respuesta);

        var json = {
            "variables_history": your_object
        }

        var Table =
                "<table class='table table-hover table-striped text-center' id='TableListDocumentos'>" +
                "<thead class='thead-dark text-center'>";
                var num = 0;
                json.variables_history.forEach(function (item) {

                    if (num == 0) {
                        Table += "<tr>";
                        Object.keys(item).forEach(function (key) {
                            Table += "<td> " + key + " </td>";
                        });
                        Table += "</tr>";
                        num = 1;
                    }
                });
            Table +=   "</thead>";
            Table +=  "<tbody>";

                    //En caso que quieras recorrer cada value de cada objecto esto valdría
                    $.each(json, function (key, variables_history) {

                        $.each(variables_history, function (key2, eventData) {

                                Table += "<tr>";
                                $.each(eventData, function (key3, eventData2) {
                                    Table += "<td> " + eventData2 + " </td>";
                                    /*console.log(eventData2);*/
                                });
                                Table += "</tr>";

                        });

                    });




        Table +=        "</tbody>" +
                    "</table>";
        $('#TablaDocumentos').html(Table);

        $('#TableListDocumentos').DataTable({
            scrollY: '185px',
          /*  scrollCollapse: true,*/
            paging: true,
            "searching": true,
            "scrollX": true,
            "language": {
                "url": "//cdn.datatables.net/plug-ins/9dcbecd42ad/i18n/Spanish.json"
            }
        });

    }

    function PintagTablaPorcentajeDocumentos(respuesta) {
        const consulta = [];

        for (var b = 0; b < respuesta.length; b++) {
            let Registro = {
                TicketsCount: respuesta[b].Total,
                TicketsAsignedTo: respuesta[b].Nombre,
                TicketsClasificationType: respuesta[b].Estatus,
            }
            consulta.push(Registro);
        }



        @*const consulta = [


            @foreach (var Com in ViewBag.DocumentosPorcentaje)
            {
                @Html.Raw("{ TicketsCount:")
                @Html.Raw(@Com.Total)
                @Html.Raw(",")

                @Html.Raw(" TicketsAsignedTo:'")
                @Html.Raw(@Com.Nombre)
                @Html.Raw("'")
                @Html.Raw(",")


                @Html.Raw(" TicketsClasificationType:'")
                @Html.Raw(@Com.Estatus)
                @Html.Raw("'")
                @Html.Raw("},")
            }
        ];*@

        const labels = Object.keys(
            consulta.reduce((obj, label) => (obj[label.TicketsAsignedTo] = true, obj), {})
        );

        const colors = {
            "Avance": "#00bcd4",
            "Faltante": "#c755db",
        };

        const datasetsObject = consulta.reduce((obj, item) => {
            obj[item.TicketsClasificationType] = obj[item.TicketsClasificationType] || {};
            obj[item.TicketsClasificationType][item.TicketsAsignedTo] = item.TicketsCount;
            return obj;
        }, {});

        const datasets = Object.keys(datasetsObject).map(name => ({
            label: name,
            backgroundColor: colors[name],
            data: labels.map(l => datasetsObject[name][l] || 0)
        }));

        const context = document.getElementById("densityChartPorcentajesDocumentosLista").getContext("2d");

        const myBarChart = new Chart(context, {
            type: "horizontalBar",
            data: { labels, datasets },
            options: {
                legend: {
                    display: false
                },
                scales: {
                    xAxes: [{ stacked: true, scaleFontSize: 8}],
                    yAxes: [{ stacked: true, scaleFontSize: 8 }]
                }
            }
        });
    }

    function PintagGraficaPorcentaje(respuesta) {

        var avence = respuesta.Total;
        var faltante = respuesta.Total - 100.00;
        $('#PPorcentaje').text(avence + " %");

        var densityCanvas = document.getElementById("densityChartAvance");

        Chart.defaults.global.defaultFontFamily = "Arial, sans-serifapple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif";
        Chart.defaults.global.defaultFontSize = 14;

        var densityData = {
            label: 'Estatus',

            options: {
                legend: {
                    labels: {
                        // This more specific font property overrides the global property
                        //fontColor: 'black',
                        defaultFontFamily: 'Arial, sans-serifapple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif',
                        fontColor: 'rgb(154, 154, 154)',
                        usePointStyle: true,
                    }
                }
            },

            data: [avence, faltante * -1
            ],
            backgroundColor: ["#00bcd4",],
            borderWidth: 1,
            hoverBorderWidth: 0,
            hoverBackgroundColor: ["#00a2b7",],
        };

        var chartOptions = {
            responsive: true,
            maintainAspectRatio: false
        };

        var barChart = new Chart(densityCanvas, {
            type: 'doughnut',
            data: {
                labels: ['Avance', 'Faltante'
                ],
                datasets: [densityData],
            },
            options: chartOptions
        });
    }

    function ValidaForm() {
        var result = false;

        $('#Select_Empresa_Empleado').css("border", "1px solid #f44336");

        if ($("#Select_Empresa_Empleado option:selected").val() > 0) {
            $('#Select_Empresa_Empleado').css("border", "1px solid #cccccc");
        }


        $('#Select_Cliente_Empleado').css("border", "1px solid #f44336");

        if ($("#Select_Cliente_Empleado option:selected").val() > 0) {
            $('#Select_Cliente_Empleado').css("border", "1px solid #cccccc");
        }

        if ($("#Select_Empresa_Empleado option:selected").val() > 0) {
            if ($("#Select_Cliente_Empleado option:selected").val() > 0) {
                result = true;
            }
        }

        return result;
    }

    function errores() {
        $.notify({
            message: "Inténtelo mas tarde."
        }, {
            type: 'danger',
            allow_dismiss: false,
            animate: {
                enter: 'animated rollIn',
                exit: 'animated rollOut'
            }
        });
    }
</script>